/// <reference types="node" />
/// <reference types="vinyl" />
/**
 * @license
 * Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
 * This code may only be used under the BSD style license found at
 * http://polymer.github.io/LICENSE.txt
 * The complete set of authors may be found at
 * http://polymer.github.io/AUTHORS.txt
 * The complete set of contributors may be found at
 * http://polymer.github.io/CONTRIBUTORS.txt
 * Code distributed by Google as part of the polymer project is also
 * subject to an additional IP rights grant found at
 * http://polymer.github.io/PATENTS.txt
 */
import { Deferred, Resolver as HydrolysisResolver } from 'hydrolysis';
import { Analyzer } from 'polymer-analyzer';
import { UrlLoader } from 'polymer-analyzer/lib/url-loader/url-loader';
import { Warning } from 'polymer-analyzer/lib/warning/warning';
import { Transform } from 'stream';
import File = require('vinyl');
import { ProjectConfig } from 'polymer-project-config';
import { FileCB } from './streams';
export interface DocumentDeps {
    imports: Array<string>;
    scripts: Array<string>;
    styles: Array<string>;
}
export interface DepsIndex {
    depsToFragments: Map<string, string[]>;
    fragmentToDeps: Map<string, string[]>;
    fragmentToFullDeps: Map<string, DocumentDeps>;
}
export declare class StreamAnalyzer extends Transform {
    config: ProjectConfig;
    loader: StreamLoader;
    analyzer: Analyzer;
    private _dependenciesStream;
    private _dependenciesProcessingStream;
    files: Map<string, File>;
    warnings: Set<Warning>;
    allFragmentsToAnalyze: Set<string>;
    foundDependencies: Set<string>;
    analyzeDependencies: Promise<DepsIndex>;
    _dependencyAnalysis: DepsIndex;
    _resolveDependencyAnalysis: (index: DepsIndex) => void;
    constructor(config: ProjectConfig);
    /**
     * The source dependency stream that Analyzer pushes discovered dependencies
     * into is connected to the post-processing stream. We want consumers to only
     * use the post-processed data so that all file objects have contents
     * loaded by default. This also makes Analyzer easier for us to test.
     */
    readonly dependencies: Transform;
    _transform(file: File, _encoding: string, callback: FileCB): void;
    _flush(done: (error?: any) => void): void;
    getFile(filepath: string): File;
    getFileByUrl(url: string): File;
    /**
     * A side-channel to add files to the loader that did not come throgh the
     * stream transformation. This is for generated files, like
     * shared-bundle.html. This should probably be refactored so that the files
     * can be injected into the stream.
     */
    addFile(file: File): void;
    printWarnings(): void;
    private countWarningsByType();
    /**
     * Attempts to retreive document-order transitive dependencies for `url`.
     */
    _getDependencies(url: string): Promise<DocumentDeps>;
    _addDependencies(filePath: string, deps: DocumentDeps): void;
    /**
     * Process the given dependency before pushing it through the stream.
     * Each dependency is only pushed through once to avoid duplicates.
     */
    pushDependency(dependencyUrl: string): void;
}
export interface BackwardsCompatibleUrlLoader extends UrlLoader, HydrolysisResolver {
}
export declare type DeferredFileCallback = (a: string) => string;
export declare class StreamLoader implements BackwardsCompatibleUrlLoader {
    config: ProjectConfig;
    analyzer: StreamAnalyzer;
    deferredFiles: Map<string, DeferredFileCallback>;
    constructor(analyzer: StreamAnalyzer);
    hasDeferredFile(filePath: string): boolean;
    hasDeferredFiles(): boolean;
    resolveDeferredFile(filePath: string, file: File): void;
    canLoad(_url: string): boolean;
    load(url: string): Promise<string>;
    /**
     * Wraps the load() method to work in a way that is compliant with vulcanize
     * & the old UrlResolver interface. To be removed once migration from
     * hydrolosis to polymer-analyzer is complete.
     */
    accept(url: string, deferred: Deferred<string>): boolean;
}
